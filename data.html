<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Regency Data Viewer (Read-only)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f6f8fa; margin: 0; padding: 0;}
    nav { background: #050039; color: white; padding: 12px 32px; font-size: 1.13em; position: sticky; top: 0; z-index: 100; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 16px rgba(0,0,0,0.03);}
    .nav-logo { height: 38px; width: auto; border-radius: 10px;}
    .nav-links a { color: white; margin-left: 38px; text-decoration: none; font-weight: 500; letter-spacing: 0.01em; padding: 7px 16px; border-radius: 18px; transition: opacity 0.2s, background 0.14s;}
    .nav-links a:hover { background: rgba(255,255,255,0.07); opacity: 0.82;}
    .container { max-width: 100vw; margin: 32px auto; background: #fff; padding: 22px 2vw 40px 2vw; border-radius: 18px; box-shadow: 0 8px 40px rgba(40,50,130,0.06);}
    h2 { color: #244385; margin-top: 0; }
    #note { margin: 10px 0 20px; padding: 12px 14px; background: #fff4d6; border: 1px solid #ffe4a3; border-radius: 10px; color: #5b4700; }
    #statsbar { margin-bottom: 22px; padding: 10px 12px 7px 5px; background: #f8fafd; border-radius: 12px; font-size:1.12em; display: flex; flex-wrap:wrap; gap:18px; align-items:center;}
    .stat { margin-right:28px; font-weight:500; color:#244385;}
    .stat .val { font-size:1.25em; font-weight:bold; margin-right:4px; color:#15172a;}
    #filterbar { margin-bottom: 28px; display: flex; align-items: center; gap: 10px;}
    #filterField { padding:8px 13px; font-size:1em; border-radius:7px; border:1.2px solid #b8bdcc; min-width:120px;}
    #filterValues { display:flex; flex-wrap:wrap; gap:10px; padding:8px 13px; border-radius:7px; border:1.2px solid #b8bdcc; min-width:180px; max-width:250px;}
    #filterValues label { display:flex; align-items:center; gap:5px; font-size:1em; }
    #clearFilterBtn { padding:8px 18px; background:#f0f3f8; color:#3b4677; border:1px solid #b8bdcc; border-radius:7px; cursor:pointer; font-weight:500;}
    #clearFilterBtn:hover { background: #e1e6f4;}
    .table-wrap { overflow-x:auto; background:#f9fafc; border-radius:14px; box-shadow: 0 2px 8px rgba(100,130,200,0.05);}
    table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 1em; margin-top:10px;}
    th, td { border-bottom: 1px solid #e2e8f0; padding: 11px 8px; text-align: left;}
    th { background: #f4f7fb; position: sticky; top:0; z-index:10;}
    .status-badge { display:inline-block; padding:6px 15px; border-radius:14px; color:white; font-weight:500; font-size:1em;}
    .status-Available { background:#8fd975; color:#246944;}
    .status-Duplicate { background:#ffe34d; color:#856900;}
    .status-Reserved { background:#f29c25; color:#6c3d00;}
    .status-Sold { background:#ff316b;}
    .status-Unavailable { background:#c9ccd5; color:#465164;}
    @media (max-width: 900px) {
      nav { flex-direction: column; align-items: stretch; padding: 8px 3vw;}
      .nav-links { margin-top: 5px;}
      .nav-links a { margin-left: 20px; font-size: 1em;}
      .nav-logo { height: 30px;}
      #statsbar {flex-direction:column; gap:8px;}
      th, td { font-size:0.98em;}
    }
  </style>
</head>
<body>
  <nav>
    <div class="nav-left">
      <a href="index.html"><img class="nav-logo" src="https://www.dropbox.com/scl/fi/7awuuf1ohhvxepbvfcth6/logo2.svg?rlkey=vgv8cijqf8fcv3jbp4ag2tfjv&raw=1" alt="Regency Logo" /></a>
    </div>
    <div class="nav-links">
      <a href="index.html">Inventory</a>
      <a href="data.html">Data</a>
    </div>
  </nav>

  <div class="container">
    <h2>Property Data (Read-only)</h2>
    <div id="note">
      This page is reading directly from Dropbox JSON. Editing is disabled until a backend (e.g., Netlify Function at
      <code>/.netlify/functions/myunits</code>) is available. :contentReference[oaicite:1]{index=1}
    </div>

    <div id="statsbar"></div>

    <div id="filterbar">
      <label>Filter:
        <select id="filterField">
          <option value="">Select Field</option>
          <option value="status" selected>Status</option>
          <option value="block">Block</option>
          <option value="bedroom">Bedroom</option>
          <option value="customer_name">Customer</option>
        </select>
      </label>
      <div id="filterValues"></div>
      <button id="clearFilterBtn" type="button">Clear</button>
    </div>

    <div class="table-wrap">
      <table id="dataTable">
        <thead>
          <tr>
            <th>Block</th>
            <th>Unit ID</th>
            <th>Status</th>
            <th>Customer</th>
            <th>Reserved Date</th>
            <th>Sold Price</th>
            <th>Bedroom</th>
            <th>Reservation Agreement</th>
            <th>Deposit Record</th>
            <th>ID Doc</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    /* ---------- CONFIG ---------- */
    // Pull from the same RAW Dropbox link as the map page:
    const CUSTOMER_JSON_URL = 'https://dl.dropboxusercontent.com/scl/fi/9tgtfvjsf2xp262eqvr5v/customerdata.json?rlkey=c9hocv3qndpuux8flfrzlv7ky&raw=1';

    const STATUS_OPTIONS = ["Available", "Duplicate", "Reserved", "Sold", "Unavailable"]; // used for filters
    let allData = [];
    let currentFilterField = "status";
    let currentFilterVals = [];

    /* ---------- HELPERS ---------- */
    const bust = url => url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now();
    function extractArray(json){
      if (Array.isArray(json)) return json;
      if (Array.isArray(json?.Data)) return json.Data;
      if (Array.isArray(json?.['Array Aggregator output'])) return json['Array Aggregator output'];
      if (Array.isArray(json?.Data?.[0]?.array)) return json.Data[0].array;
      if (Array.isArray(json?.Data?.array)) return json.Data.array;
      return [];
    }
    function normalizeStatus(s){
      if(!s) return "";
      s = String(s).trim().toLowerCase();
      if (s.startsWith('avail')) return 'Available';
      if (s.startsWith('reserv')) return 'Reserved';
      if (s.startsWith('sold')) return 'Sold';
      if (s.startsWith('dup')) return 'Duplicate';
      if (s.startsWith('unavail') || s==='na') return 'Unavailable';
      return s;
    }
    function formatLink(val){
      if (!val) return "";
      if (/^https?:\/\/\S+/.test(val)) {
        return `<a href="${val}" target="_blank" rel="noopener">Click here</a>`;
      }
      return val;
    }

    /* ---------- RENDER ---------- */
    function renderStats() {
      const total = allData.length;
      const counts = Object.fromEntries(STATUS_OPTIONS.map(s => [s, 0]));
      for (const r of allData) {
        const s = (r.status||"");
        if (counts.hasOwnProperty(s)) counts[s] += 1;
      }
      const bedrooms4 = allData.filter(r => String(r.bedroom) === "4").length;
      const bedrooms5 = allData.filter(r => String(r.bedroom) === "5").length;

      document.getElementById("statsbar").innerHTML =
        `<span class="stat"><span class="val">${total}</span>Units</span>` +
        `<span class="stat"><span class="val">${counts.Available}</span>Available</span>` +
        `<span class="stat"><span class="val">${counts.Reserved}</span>Reserved</span>` +
        `<span class="stat"><span class="val">${counts.Sold}</span>Sold</span>` +
        `<span class="stat"><span class="val">${counts.Unavailable}</span>Unavailable</span>` +
        `<span class="stat"><span class="val">${bedrooms4}</span>4-Bedroom</span>` +
        `<span class="stat"><span class="val">${bedrooms5}</span>5-Bedroom</span>`;
    }

    function renderTable() {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      let filtered = allData;
      if (currentFilterField && currentFilterVals.length) {
        filtered = allData.filter(row => currentFilterVals.includes((row[currentFilterField]||"").toString()));
      }
      for (const row of filtered) {
        const tr = document.createElement("tr");
        const statusBadge = `<span class="status-badge status-${(row.status||"").replace(/\s/g,"")}">${row.status||""}</span>`;
        tr.innerHTML = `
          <td>${row.block||""}</td>
          <td>${row.unitid||""}</td>
          <td>${statusBadge}</td>
          <td>${row.customer_name||""}</td>
          <td>${row.reserved_date||""}</td>
          <td>${row.sold_price||""}</td>
          <td>${row.bedroom||""}</td>
          <td>${formatLink(row.reservation_agreement)}</td>
          <td>${formatLink(row.deposit_record)}</td>
          <td>${formatLink(row.id_doc)}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function updateFilterUI() {
      const field = document.getElementById("filterField").value;
      const valsEl = document.getElementById("filterValues");
      valsEl.innerHTML = "";
      valsEl.style.display = "none";
      if (field && allData.length) {
        valsEl.style.display = "";
        let options = [];
        if (field === "status") {
          options = STATUS_OPTIONS;
        } else {
          options = Array.from(new Set(allData.map(r => (r[field] || "")))).filter(v => v && v !== "undefined").sort();
        }
        valsEl.innerHTML = options.map(opt =>
          `<label><input type="checkbox" value="${opt}" ${currentFilterVals.includes(opt) ? 'checked' : ''}> ${opt}</label>`
        ).join("\n");
        valsEl.querySelectorAll('input[type="checkbox"]').forEach(chk => {
          chk.onchange = () => {
            currentFilterVals = Array.from(valsEl.querySelectorAll('input[type="checkbox"]:checked')).map(c => c.value);
            renderTable();
          };
        });
      }
    }

    /* ---------- LOAD ---------- */
    async function fetchData(){
      const res = await fetch(bust(CUSTOMER_JSON_URL), { cache: 'no-store' });
      const raw = await res.json();
      const arr = extractArray(raw);

      // Map Dropbox customer JSON â†’ table schema used here
      allData = arr.map((r, i) => {
        const unit = r.unitId || r.unitID || "";
        return {
          id: i + 1,
          block: r.Block || r.block || "",
          unitid: unit,
          status: normalizeStatus(r.status),
          customer_name: r["Customer Name"] || r.customer_name || "",
          reserved_date: r["Reserved Date"] || r.reserved_date || "",
          sold_price: r["Sold Price"] || r.sold_price || "",
          bedroom: r.Bedroom ?? r.bedroom ?? "",
          reservation_agreement: r["Reservation agreement"] || r.reservation_agreement || "",
          deposit_record: r["Deposit record"] || r.deposit_record || "",
          id_doc: r.ID || r.id_doc || ""
        };
      });

      renderStats();
      renderTable();
      updateFilterUI();
      document.getElementById("filterField").dispatchEvent(new Event("change"));
    }

    document.getElementById("filterField").onchange = function() {
      currentFilterField = this.value;
      currentFilterVals = [];
      updateFilterUI();
      renderTable();
    };

    document.getElementById("clearFilterBtn").onclick = function() {
      document.getElementById("filterField").value = "status";
      currentFilterField = "status";
      currentFilterVals = [];
      updateFilterUI();
      renderTable();
      document.getElementById("filterField").dispatchEvent(new Event("change"));
    };

    fetchData();
  </script>
</body>
</html>
