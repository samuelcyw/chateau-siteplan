<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Regency Site Plan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{margin:0;padding:0;width:100vw;min-height:100vh;font-family:'Segoe UI',Arial,sans-serif;background:#f6f8fa;overflow-x:hidden;}
    nav{background:#050039;color:#fff;padding:10px 32px;position:sticky;top:0;z-index:100;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 16px rgba(0,0,0,.03);min-height:54px}
    .nav-left{display:flex;align-items:center;gap:16px}
    .nav-logo{height:38px;width:auto;border-radius:10px;display:block}
    .nav-links{display:flex;align-items:center;gap:12px}
    .nav-links a,.btn{color:#fff;text-decoration:none;font-weight:500;letter-spacing:.01em;padding:7px 16px;border-radius:18px;border:1px solid transparent}
    .nav-links a:hover,.btn:hover{background:rgba(255,255,255,.08)}
    .meta{font-size:.82em;opacity:.9}
    .counts{font-size:.82em;opacity:.85}
    .btn{cursor:pointer;border-color:rgba(255,255,255,.35);background:transparent}
    @media(max-width:700px){nav{flex-direction:column;align-items:stretch;padding:8px 3vw}.nav-logo{height:30px}}
    #floorplan-container{width:100vw;max-width:100vw;background:#fff;overflow-x:auto;display:flex;justify-content:center;align-items:center;min-height:64vh}
    #floorplan-container svg{display:block;width:100vw!important;max-width:100vw!important;height:auto!important;aspect-ratio:16/9;margin:0 auto}
    #unit-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;pointer-events:none}
    #unit-modal .modal-overlay{position:absolute;inset:0;background:rgba(36,37,44,.22);backdrop-filter:blur(2px);pointer-events:all}
    #unit-modal .modal-content{position:relative;background:#fff;border-radius:18px;box-shadow:0 16px 56px rgba(50,60,99,.18);max-width:95vw;width:410px;padding:34px 28px 24px;border:1.5px solid #F1F1F1;pointer-events:all}
    #modal-close-btn{position:absolute;top:15px;right:20px;border:none;background:none;font-size:2.1em;color:#b7b7b7;cursor:pointer}
    #modal-details{margin-top:18px;font-size:1.05em;line-height:1.85;color:#30323e}
    .unit-header{font-size:2em;color:#244385;font-weight:700;margin:0 0 5px;letter-spacing:.03em}
    .info-row{margin:0 0 4px}
    .info-label{font-weight:600;color:#888ea8;display:inline-block;min-width:120px}
    .info-value{color:#364266;font-weight:500}
  </style>
</head>
<body>
  <nav>
    <div class="nav-left">
      <a href="index.html" aria-label="Inventory Home">
        <img class="nav-logo" src="https://www.dropbox.com/scl/fi/7awuuf1ohhvxepbvfcth6/logo2.svg?rlkey=vgv8cijqf8fcv3jbp4ag2tfjv&raw=1" alt="Regency Logo">
      </a>
      <div class="meta" id="last-updated">Last updated: â€”</div>
      <div class="counts" id="counts">Statuses: 0 | Customers: 0</div>
    </div>
    <div class="nav-links">
      <a href="index.html">Inventory</a>
      <a href="data.html">Data</a>
      <button class="btn" id="refresh-btn">Refresh</button>
    </div>
  </nav>

  <div id="floorplan-container"></div>

  <div id="unit-modal" aria-hidden="true">
    <div class="modal-overlay"></div>
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="unit-header">
      <button id="modal-close-btn" aria-label="Close">&times;</button>
      <div id="modal-details"></div>
    </div>
  </div>

  <script>
    /* ---------- CONFIG ---------- */
    const REFRESH_MS = 60_000;

    // IMPORTANT: make sure these two URLs are the EXACT files your automation updates.
const CUSTOMER_JSON_URL = 'https://dl.dropboxusercontent.com/scl/fi/9tgtfvjsf2xp262eqvr5v/customerdata.json?rlkey=c9hocv3qndpuux8flfrzlv7ky&raw=1';
const STATUS_JSON_URL   = 'https://dl.dropboxusercontent.com/scl/fi/zptyn3as4w9h9ao9smdy5/status.json?rlkey=g1gumloy76bw7m7atftifnxt8&raw=1';


    const STATUS_COLOR = {
      Available:'#CCEEEE', Reserved:'orange', Duplicate:'#FFD700', Sold:'#FF7F7F', Unavailable:'#CCCCCC'
    };

    /* ---------- UTILS ---------- */
    const $ = s => document.querySelector(s);
    const bust = url => url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now();
    const isValidUrl = s => { try { new URL(s); return true; } catch { return false; } };
    function normalizeStatus(s){
      if(!s) return null;
      s = String(s).trim().toLowerCase();
      if (s.startsWith('avail')) return 'Available';
      if (s.startsWith('reserv')) return 'Reserved';
      if (s.startsWith('sold')) return 'Sold';
      if (s.startsWith('dup')) return 'Duplicate';
      if (s.startsWith('unavail') || s==='na') return 'Unavailable';
      return null;
    }
    // Flexible array extractor (covers your current Make outputs)
    function extractArray(json){
      if (Array.isArray(json)) return json;
      if (Array.isArray(json?.Data)) return json.Data;                    // { Data: [...] }
      if (Array.isArray(json?.['Array Aggregator output'])) return json['Array Aggregator output'];
      if (Array.isArray(json?.Data?.[0]?.array)) return json.Data[0].array; // { Data:[{array:[...]}] }
      // sometimes Make wraps as { Data:{ array:[...] } }
      if (Array.isArray(json?.Data?.array)) return json.Data.array;
      return [];
    }

    /* ---------- STATE ---------- */
    let customerRows = [];           // raw array of customer records
    let customerMap = new Map();     // unitId -> record
    let statusCount = 0;

    function rebuildCustomerMap(){
      customerMap = new Map();
      for (const row of customerRows){
        const id = (row.unitId || row.unitID || '').trim().toLowerCase();
        if (id) customerMap.set(id, row);
      }
    }

    async function refreshCustomerData(){
      const res = await fetch(bust(CUSTOMER_JSON_URL), { cache:'no-store' });
      const json = await res.json();
      window._customerJSON = json; // for quick inspection in DevTools
      customerRows = extractArray(json);
      rebuildCustomerMap();
    }

    async function loadSiteplan(){
      const res = await fetch('siteplan.svg', { cache:'no-store' });
      const svg = await res.text();
      $('#floorplan-container').innerHTML = svg;
      await applyStatusAndClicks();
    }

    async function applyStatusAndClicks(){
      const res = await fetch(bust(STATUS_JSON_URL), { cache:'no-store' });
      const json = await res.json();
      window._statusJSON = json; // for quick inspection
      const units = extractArray(json);

      let painted = 0;
      statusCount = units.length;

      for (const u of units){
        const id = (u.unitId || u.unitID || '').trim();
        const status = normalizeStatus(u.status);
        if (!id || !status) continue;

        const g = document.getElementById(id);
        if (!g) continue; // not present in SVG

        const shape = g.querySelector('[id$="-shape"]') || g.querySelector('path,rect,polygon');
        if (shape && STATUS_COLOR[status]) {
          shape.setAttribute('fill', STATUS_COLOR[status]);
          painted++;
        }
        g.style.cursor = 'pointer';
        g.onclick = () => showUnitModal(id);
      }

      const now = new Date();
      $('#last-updated').textContent = `Last updated: ${now.toLocaleString()} (painted ${painted} units)`;
      $('#counts').textContent = `Statuses: ${statusCount} | Customers: ${customerRows.length}`;
    }

    function showUnitModal(unitId){
      const key = String(unitId).toLowerCase();
      const u = customerMap.get(key);
      let html = `<div id="unit-header" class="unit-header">Unit ${unitId.replace('unit','')}</div>`;

      if (!u){
        html += `<em style="color:#aaa;">No data available.</em>
                 <div class="info-row" style="margin-top:8px;color:#9aa1b5;font-size:.9em">
                   Tip: Customers loaded = <b>${customerRows.length}</b>. If this is 0, verify the CUSTOMER_JSON_URL points to the updated Dropbox file.
                 </div>`;
      } else {
        const fields = [
          ['Status','status'],
          ['Customer','Customer Name'],
          ['Reserved Date','Reserved Date'],
          ['Sold Price','Sold Price'],
          ['Bedroom','Bedroom'],
          ['Reservation agreement','Reservation agreement'],
          ['Deposit record','Deposit record'],
          ['ID','ID']
        ];
        for (const [label,key] of fields){
          const val = u[key];
          if (!val) continue;
          if (['Reservation agreement','Deposit record','ID'].includes(label) && isValidUrl(val)){
            html += `<div class="info-row"><span class="info-label">${label}:</span>
                       <span class="info-value"><a href="${val}" target="_blank" rel="noopener noreferrer">click here</a></span>
                     </div>`;
          } else {
            html += `<div class="info-row"><span class="info-label">${label}:</span> <span class="info-value">${val}</span></div>`;
          }
        }
      }

      document.getElementById('modal-details').innerHTML = html;
      const modal = document.getElementById('unit-modal');
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
    }

    function closeModal(){
      const modal = document.getElementById('unit-modal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
    }

    /* ---------- INIT ---------- */
    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('modal-close-btn').onclick = closeModal;
      document.querySelector('#unit-modal .modal-overlay').onclick = closeModal;
      window.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

      // First load
      try {
        await refreshCustomerData();
        await loadSiteplan();
      } catch (e){ console.error('initial load error', e); }

      // Manual refresh
      document.getElementById('refresh-btn').onclick = async () => {
        try { await refreshCustomerData(); await loadSiteplan(); } catch(e){ console.error(e); }
      };

      // Periodic refresh
      setInterval(async () => {
        try { await refreshCustomerData(); await loadSiteplan(); } catch(e){ console.error('periodic refresh error', e); }
      }, REFRESH_MS);
    });
  </script>
</body>
</html>

